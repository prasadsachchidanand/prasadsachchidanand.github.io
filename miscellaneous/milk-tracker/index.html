<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š Milk & Newspaper Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="hidden">
        <div class="max-w-md mx-auto mt-20 bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-blue-600 mb-2">ðŸ“Š Expense Tracker</h2>
                <p class="text-gray-600">Sign in to manage your expenses</p>
            </div>
            <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- App Screen -->
    <div id="appScreen" class="hidden">
        <div class="max-w-7xl mx-auto p-4 md:p-6">
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <!-- Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-blue-600">ðŸ“Š Expense Tracker</h1>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600" id="userEmail"></span>
                        <button onclick="handleLogout()"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                            Logout
                        </button>
                    </div>
                </div>

                <!-- Alert -->
                <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg mb-6">
                    <strong>âœ¨ Optimized & Real-time!</strong> Data syncs instantly with efficient caching and batched
                    updates.
                </div>

                <!-- Status Message -->
                <div id="status"
                    class="hidden bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-6"></div>

                <!-- Loading -->
                <div id="loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mb-4"></div>
                    <p class="text-gray-600">Loading your data...</p>
                </div>

                <!-- Main App -->
                <div id="app" class="hidden">
                    <!-- Controls -->
                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <label class="font-semibold text-gray-700">Month:</label>
                        <input type="month" id="monthSelect"
                            class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <span id="paidBadge"
                            class="hidden bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">âœ“
                            Paid</span>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-sm opacity-90 mb-2">Milk Total</h3>
                            <p class="text-4xl font-bold mb-1">â‚¹<span id="displayMilkTotal">0.00</span></p>
                            <p class="text-xs opacity-80"><span id="displayMilkQty">0</span> kg @ â‚¹75/kg</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-sm opacity-90 mb-2">The Hindu</h3>
                            <p class="text-4xl font-bold mb-1"><span id="displayHinduCount">0</span></p>
                            <p class="text-xs opacity-80">days</p>
                        </div>
                        <div
                            class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-sm opacity-90 mb-2">Hindustan</h3>
                            <p class="text-4xl font-bold mb-1"><span id="displayHindustanCount">0</span></p>
                            <p class="text-xs opacity-80">days</p>
                        </div>
                        <div
                            class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-sm opacity-90 mb-2">Misc Expenses</h3>
                            <p class="text-4xl font-bold mb-1">â‚¹<span id="displayMiscTotal">0.00</span></p>
                            <p class="text-xs opacity-80"><span id="displayMiscCount">0</span> items</p>
                        </div>
                    </div>

                    <!-- Newspaper Rates Section -->
                    <div class="bg-gray-50 p-6 rounded-xl mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Newspaper Rates</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">The Hindu Rate
                                    (â‚¹/day)</label>
                                <input type="number" id="hinduRate" value="0" step="0.01" min="0"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Hindustan Rate
                                    (â‚¹/day)</label>
                                <input type="number" id="hindustanRate" value="0" step="0.01" min="0"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold text-gray-700">The Hindu Total:</span>
                                <span class="text-xl font-bold text-blue-600">â‚¹<span id="hinduTotal">0.00</span></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-gray-700">Hindustan Total:</span>
                                <span class="text-xl font-bold text-purple-600">â‚¹<span
                                        id="hindustanTotal">0.00</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3 mb-6">
                        <button onclick="toggleForm('daily')"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            + Add Daily Entry
                        </button>
                        <button onclick="toggleForm('misc')"
                            class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            + Add Misc Expense
                        </button>
                        <button id="markPaidBtn" onclick="markAsPaid()"
                            class="hidden bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            âœ“ Mark as Paid
                        </button>
                        <button onclick="downloadPDF()"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            ðŸ“„ Download PDF
                        </button>
                    </div>

                    <!-- Add Daily Entry Form -->
                    <div id="dailyFormContainer" class="hidden bg-gray-50 p-6 rounded-xl mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Add Daily Entry</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                                <input type="date" id="inputDate"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Milk (kg)</label>
                                <input type="number" id="inputMilk" step="0.5" value="0.5" min="0"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Newspapers</label>
                                <div class="flex items-center gap-3 mt-2">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="inputTheHindu" checked
                                            class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                        <span class="text-sm font-medium text-gray-700">The Hindu</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="inputHindustan" checked
                                            class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                                        <span class="text-sm font-medium text-gray-700">Hindustan</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveDailyEntry()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                                Save Daily Entry
                            </button>
                            <button onclick="toggleForm('daily')"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Add Misc Expense Form -->
                    <div id="miscFormContainer" class="hidden bg-gray-50 p-6 rounded-xl mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Add Miscellaneous Expense</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                                <input type="date" id="miscDate"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Amount (â‚¹)</label>
                                <input type="number" id="miscAmount" step="0.01" value="0" min="0"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                                <input type="text" id="miscDescription" placeholder="e.g., Travel, Grocery, etc."
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveMiscExpense()"
                                class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                                Save Expense
                            </button>
                            <button onclick="toggleForm('misc')"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Daily Entries Table -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Daily Entries</h3>
                        <div class="overflow-x-auto rounded-xl border border-gray-200">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Date</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Milk (kg)
                                        </th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Milk Cost
                                        </th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">The Hindu
                                        </th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Hindustan
                                        </th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="entriesTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Misc Expenses Table -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Miscellaneous Expenses</h3>
                        <div class="overflow-x-auto rounded-xl border border-gray-200">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Date</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Description
                                        </th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Amount</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="miscTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Grand Total Section -->
                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex flex-col md:flex-row justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold opacity-90 mb-2">Grand Total for <span
                                        id="currentMonthLabel">Current Month</span></h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm opacity-80">
                                    <div>Milk: â‚¹<span id="grandMilk">0.00</span></div>
                                    <div>Hindu: â‚¹<span id="grandHindu">0.00</span></div>
                                    <div>Hindustan: â‚¹<span id="grandHindustan">0.00</span></div>
                                    <div>Misc: â‚¹<span id="grandMisc">0.00</span></div>
                                </div>
                            </div>
                            <div class="mt-4 md:mt-0 text-center md:text-right">
                                <div class="text-2xl font-bold opacity-90">Total Amount</div>
                                <div class="text-5xl font-bold mt-2">â‚¹<span id="grandTotal">0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDj_uDo_s9aKhLAiwtxgyVMMLddOC_yWJw",
            authDomain: "daily-milk-tracker-37d73.firebaseapp.com",
            projectId: "daily-milk-tracker-37d73",
            storageBucket: "daily-milk-tracker-37d73.firebasestorage.app",
            messagingSenderId: "882401862412",
            appId: "1:882401862412:web:8d4eea1ed638a644cd1f29",
            measurementId: "G-JV51KSV0EB"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const MILK_RATE = 75;
        let currentMonth = new Date().toISOString().slice(0, 7);
        let dailyEntries = [];
        let miscExpenses = [];
        let currentUser = null;

        // Optimization: Cache totals to avoid recalculation
        let cachedTotals = {
            milkTotal: 0,
            milkQty: 0,
            hinduCount: 0,
            hindustanCount: 0,
            miscTotal: 0,
            miscCount: 0
        };

        // Optimization: Debounce rate input changes
        let rateUpdateTimeout;

        // Optimization: Real-time listeners for automatic updates
        let dailyEntriesListener = null;
        let miscExpensesListener = null;
        let paymentsListener = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                initializeApp();
            } else {
                currentUser = null;
                // Clean up listeners
                if (dailyEntriesListener) dailyEntriesListener();
                if (miscExpensesListener) miscExpensesListener();
                if (paymentsListener) paymentsListener();
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
            }
        });

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                errorDiv.classList.add('hidden');
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function initializeApp() {
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('inputDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('miscDate').value = new Date().toISOString().slice(0, 10);

            document.getElementById('monthSelect').addEventListener('change', (e) => {
                currentMonth = e.target.value;
                setupRealtimeListeners();
            });

            // Optimization: Debounced rate updates
            const hinduRateInput = document.getElementById('hinduRate');
            const hindustanRateInput = document.getElementById('hindustanRate');

            hinduRateInput.addEventListener('input', debounceRateUpdate);
            hindustanRateInput.addEventListener('input', debounceRateUpdate);

            setupRealtimeListeners();
        }

        // Optimization: Debounce function to reduce calculations
        function debounceRateUpdate() {
            clearTimeout(rateUpdateTimeout);
            rateUpdateTimeout = setTimeout(() => {
                updateNewspaperTotals();
                updateGrandTotal();
            }, 300);
        }

        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden', 'bg-green-50', 'border-green-200', 'text-green-800', 'bg-red-50', 'border-red-200', 'text-red-800');
            if (isError) {
                statusEl.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
            } else {
                statusEl.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
            }
            setTimeout(() => statusEl.classList.add('hidden'), 3000);
        }

        // Optimization: Real-time listeners instead of manual refresh
        function setupRealtimeListeners() {
            if (!currentUser) return;

            // Clean up existing listeners
            if (dailyEntriesListener) dailyEntriesListener();
            if (miscExpensesListener) miscExpensesListener();
            if (paymentsListener) paymentsListener();

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');

            // Daily entries listener
            dailyEntriesListener = db.collection('dailyEntries')
                .where('userId', '==', currentUser.uid)
                .where('month', '==', currentMonth)
                .orderBy('date')
                .onSnapshot(snapshot => {
                    dailyEntries = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    calculateCachedTotals();
                    renderDailyEntries();
                    updateAllDisplays();

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                }, error => {
                    console.error('Error with daily entries listener:', error);
                    showStatus('Error loading daily entries: ' + error.message, true);
                });

            // Misc expenses listener
            miscExpensesListener = db.collection('miscExpenses')
                .where('userId', '==', currentUser.uid)
                .where('month', '==', currentMonth)
                .orderBy('date')
                .onSnapshot(snapshot => {
                    miscExpenses = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    calculateCachedTotals();
                    renderMiscExpenses();
                    updateAllDisplays();
                }, error => {
                    console.error('Error with misc expenses listener:', error);
                    showStatus('Error loading expenses: ' + error.message, true);
                });

            // Payments listener
            paymentsListener = db.collection('payments')
                .where('userId', '==', currentUser.uid)
                .where('month', '==', currentMonth)
                .onSnapshot(snapshot => {
                    const isPaid = !snapshot.empty;
                    updatePaidStatus(isPaid);
                }, error => {
                    console.error('Error with payments listener:', error);
                });
        }

        // Optimization: Calculate all totals once and cache them
        function calculateCachedTotals() {
            cachedTotals.milkTotal = dailyEntries.reduce((sum, e) => sum + (parseFloat(e.milkCost) || 0), 0);
            cachedTotals.milkQty = dailyEntries.reduce((sum, e) => sum + (parseFloat(e.milk) || 0), 0);
            cachedTotals.hinduCount = dailyEntries.filter(e => e.theHindu).length;
            cachedTotals.hindustanCount = dailyEntries.filter(e => e.hindustan).length;
            cachedTotals.miscTotal = miscExpenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            cachedTotals.miscCount = miscExpenses.length;
        }

        // Optimization: Batch DOM updates using DocumentFragment
        function renderDailyEntries() {
            const tbody = document.getElementById('entriesTable');

            if (dailyEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No daily entries for this month</td></tr>';
                return;
            }

            const fragment = document.createDocumentFragment();

            dailyEntries.forEach(entry => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm">${entry.date}</td>
                    <td class="px-4 py-3 text-sm text-right">${entry.milk}</td>
                    <td class="px-4 py-3 text-sm text-right">â‚¹${entry.milkCost.toFixed(2)}</td>
                    <td class="px-4 py-3 text-center">${entry.theHindu ? '<span class="text-green-600 text-lg">âœ“</span>' : '<span class="text-gray-400 text-lg">âœ—</span>'}</td>
                    <td class="px-4 py-3 text-center">${entry.hindustan ? '<span class="text-green-600 text-lg">âœ“</span>' : '<span class="text-gray-400 text-lg">âœ—</span>'}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteDailyEntry('${entry.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-semibold transition">
                            Delete
                        </button>
                    </td>
                `;
                fragment.appendChild(tr);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function renderMiscExpenses() {
            const tbody = document.getElementById('miscTable');

            if (miscExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">No miscellaneous expenses for this month</td></tr>';
                return;
            }

            const fragment = document.createDocumentFragment();

            miscExpenses.forEach(expense => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm">${expense.date}</td>
                    <td class="px-4 py-3 text-sm">${expense.description}</td>
                    <td class="px-4 py-3 text-sm text-right">â‚¹${expense.amount.toFixed(2)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteMiscExpense('${expense.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-semibold transition">
                            Delete
                        </button>
                    </td>
                `;
                fragment.appendChild(tr);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        // Optimization: Single batched update function
        function updateAllDisplays() {
            updateDailySummary();
            updateNewspaperTotals();
            updateMiscSummary();
            updateGrandTotal();
        }

        function updateDailySummary() {
            document.getElementById('displayMilkTotal').textContent = cachedTotals.milkTotal.toFixed(2);
            document.getElementById('displayMilkQty').textContent = cachedTotals.milkQty.toFixed(1);
            document.getElementById('displayHinduCount').textContent = cachedTotals.hinduCount;
            document.getElementById('displayHindustanCount').textContent = cachedTotals.hindustanCount;
            document.getElementById('grandMilk').textContent = cachedTotals.milkTotal.toFixed(2);
            document.getElementById('currentMonthLabel').textContent = currentMonth;

            const markPaidBtn = document.getElementById('markPaidBtn');
            if (dailyEntries.length > 0 || miscExpenses.length > 0) {
                markPaidBtn.classList.remove('hidden');
            } else {
                markPaidBtn.classList.add('hidden');
            }
        }

        function updateNewspaperTotals() {
            const hinduRate = parseFloat(document.getElementById('hinduRate').value) || 0;
            const hindustanRate = parseFloat(document.getElementById('hindustanRate').value) || 0;

            const hinduTotal = cachedTotals.hinduCount * hinduRate;
            const hindustanTotal = cachedTotals.hindustanCount * hindustanRate;

            document.getElementById('hinduTotal').textContent = hinduTotal.toFixed(2);
            document.getElementById('hindustanTotal').textContent = hindustanTotal.toFixed(2);
            document.getElementById('grandHindu').textContent = hinduTotal.toFixed(2);
            document.getElementById('grandHindustan').textContent = hindustanTotal.toFixed(2);
        }

        function updateMiscSummary() {
            document.getElementById('displayMiscTotal').textContent = cachedTotals.miscTotal.toFixed(2);
            document.getElementById('displayMiscCount').textContent = cachedTotals.miscCount;
            document.getElementById('grandMisc').textContent = cachedTotals.miscTotal.toFixed(2);
        }

        function updateGrandTotal() {
            const milkTotal = cachedTotals.milkTotal;
            const hinduTotal = parseFloat(document.getElementById('grandHindu').textContent) || 0;
            const hindustanTotal = parseFloat(document.getElementById('grandHindustan').textContent) || 0;
            const miscTotal = cachedTotals.miscTotal;

            const grandTotal = milkTotal + hinduTotal + hindustanTotal + miscTotal;
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        function updatePaidStatus(isPaid) {
            const paidBadge = document.getElementById('paidBadge');
            const markPaidBtn = document.getElementById('markPaidBtn');

            if (isPaid) {
                paidBadge.classList.remove('hidden');
                markPaidBtn.classList.add('hidden');
            } else {
                paidBadge.classList.add('hidden');
                if (dailyEntries.length > 0 || miscExpenses.length > 0) {
                    markPaidBtn.classList.remove('hidden');
                }
            }
        }

        function toggleForm(type) {
            if (type === 'daily') {
                const form = document.getElementById('dailyFormContainer');
                const miscForm = document.getElementById('miscFormContainer');
                form.classList.toggle('hidden');
                miscForm.classList.add('hidden');
            } else if (type === 'misc') {
                const form = document.getElementById('miscFormContainer');
                const dailyForm = document.getElementById('dailyFormContainer');
                form.classList.toggle('hidden');
                dailyForm.classList.add('hidden');
            }
        }

        async function saveDailyEntry() {
            if (!currentUser) return;

            const dateValue = document.getElementById('inputDate').value;
            const milkValue = document.getElementById('inputMilk').value;
            const milkNumber = parseFloat(milkValue);
            const hinduValue = document.getElementById('inputTheHindu').checked;
            const hindustanValue = document.getElementById('inputHindustan').checked;

            if (!dateValue || !milkValue || isNaN(milkNumber) || milkNumber < 0) {
                alert('Please fill in all fields correctly.');
                return;
            }

            if (!dateValue.startsWith(currentMonth)) {
                alert('Please add entries only for the selected month');
                return;
            }

            const exists = dailyEntries.find(e => e.date === dateValue);
            if (exists) {
                alert('Entry for this date already exists');
                return;
            }

            try {
                const entry = {
                    userId: currentUser.uid,
                    date: dateValue,
                    month: currentMonth,
                    milk: milkNumber,
                    milkCost: milkNumber * MILK_RATE,
                    theHindu: hinduValue,
                    hindustan: hindustanValue,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('dailyEntries').add(entry);
                showStatus('Daily entry saved successfully!');
                toggleForm('daily');

                document.getElementById('inputDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('inputMilk').value = '0.5';
                document.getElementById('inputTheHindu').checked = true;
                document.getElementById('inputHindustan').checked = true;

                // No need to call loadData() - real-time listener will update automatically
            } catch (error) {
                console.error('Error saving daily entry:', error);
                showStatus('Error saving daily entry: ' + error.message, true);
            }
        }

        async function saveMiscExpense() {
            if (!currentUser) return;

            const dateValue = document.getElementById('miscDate').value;
            const amountValue = document.getElementById('miscAmount').value;
            const amountNumber = parseFloat(amountValue);
            const descriptionValue = document.getElementById('miscDescription').value.trim();

            if (!dateValue || !amountValue || isNaN(amountNumber) || amountNumber <= 0 || !descriptionValue) {
                alert('Please fill in all fields correctly. Amount must be greater than 0.');
                return;
            }

            if (!dateValue.startsWith(currentMonth)) {
                alert('Please add expenses only for the selected month');
                return;
            }

            try {
                const expense = {
                    userId: currentUser.uid,
                    date: dateValue,
                    month: currentMonth,
                    amount: amountNumber,
                    description: descriptionValue,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('miscExpenses').add(expense);
                showStatus('Miscellaneous expense saved successfully!');
                toggleForm('misc');

                document.getElementById('miscDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('miscAmount').value = '0';
                document.getElementById('miscDescription').value = '';

                // No need to call loadData() - real-time listener will update automatically
            } catch (error) {
                console.error('Error saving misc expense:', error);
                showStatus('Error saving expense: ' + error.message, true);
            }
        }

        async function deleteDailyEntry(id) {
            if (!confirm('Delete this daily entry?')) return;

            try {
                await db.collection('dailyEntries').doc(id).delete();
                showStatus('Daily entry deleted successfully!');
                // Real-time listener will update automatically
            } catch (error) {
                console.error('Error deleting daily entry:', error);
                showStatus('Error deleting daily entry: ' + error.message, true);
            }
        }

        async function deleteMiscExpense(id) {
            if (!confirm('Delete this expense?')) return;

            try {
                await db.collection('miscExpenses').doc(id).delete();
                showStatus('Expense deleted successfully!');
                // Real-time listener will update automatically
            } catch (error) {
                console.error('Error deleting expense:', error);
                showStatus('Error deleting expense: ' + error.message, true);
            }
        }

        async function markAsPaid() {
            if (!currentUser) return;

            try {
                const hinduRate = parseFloat(document.getElementById('hinduRate').value) || 0;
                const hindustanRate = parseFloat(document.getElementById('hindustanRate').value) || 0;
                const hinduTotal = cachedTotals.hinduCount * hinduRate;
                const hindustanTotal = cachedTotals.hindustanCount * hindustanRate;
                const grandTotal = cachedTotals.milkTotal + hinduTotal + hindustanTotal + cachedTotals.miscTotal;

                await db.collection('payments').add({
                    userId: currentUser.uid,
                    month: currentMonth,
                    milkTotal: cachedTotals.milkTotal,
                    hinduCount: cachedTotals.hinduCount,
                    hindustanCount: cachedTotals.hindustanCount,
                    miscTotal: cachedTotals.miscTotal,
                    grandTotal: grandTotal,
                    paidDate: new Date().toISOString().slice(0, 10),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showStatus('Marked as paid!');
                // Real-time listener will update automatically
            } catch (error) {
                console.error('Error marking as paid:', error);
                showStatus('Error marking as paid: ' + error.message, true);
            }
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const hinduRate = parseFloat(document.getElementById('hinduRate').value) || 0;
            const hindustanRate = parseFloat(document.getElementById('hindustanRate').value) || 0;
            const hinduTotal = cachedTotals.hinduCount * hinduRate;
            const hindustanTotal = cachedTotals.hindustanCount * hindustanRate;
            const grandTotal = cachedTotals.milkTotal + hinduTotal + hindustanTotal + cachedTotals.miscTotal;

            doc.setFontSize(20);
            doc.text('Expense Summary', 105, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.text(`Month: ${currentMonth}`, 20, 35);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 42);

            // Milk Summary
            doc.setFontSize(14);
            doc.text('Milk Summary', 20, 55);
            doc.setFontSize(11);
            doc.text(`Total Quantity: ${cachedTotals.milkQty.toFixed(1)} kg`, 20, 63);
            doc.text(`Rate: Rs ${MILK_RATE}/kg`, 20, 70);
            doc.text(`Total Cost: Rs ${cachedTotals.milkTotal.toFixed(2)}`, 20, 77);

            // Newspaper Summary
            doc.setFontSize(14);
            doc.text('Newspaper Summary', 20, 92);
            doc.setFontSize(11);
            doc.text(`The Hindu:`, 20, 100);
            doc.text(`  Days: ${cachedTotals.hinduCount}`, 20, 107);
            doc.text(`  Rate: Rs ${hinduRate.toFixed(2)}/day`, 20, 114);
            doc.text(`  Total: Rs ${hinduTotal.toFixed(2)}`, 20, 121);

            doc.text(`Hindustan:`, 20, 132);
            doc.text(`  Days: ${cachedTotals.hindustanCount}`, 20, 139);
            doc.text(`  Rate: Rs ${hindustanRate.toFixed(2)}/day`, 20, 146);
            doc.text(`  Total: Rs ${hindustanTotal.toFixed(2)}`, 20, 153);

            // Misc Expenses Summary
            doc.setFontSize(14);
            doc.text('Miscellaneous Expenses', 20, 168);
            doc.setFontSize(11);

            let yPos = 176;
            miscExpenses.slice(0, 5).forEach(expense => {
                doc.text(`${expense.date}: ${expense.description} - Rs ${expense.amount.toFixed(2)}`, 20, yPos);
                yPos += 7;
            });

            if (miscExpenses.length > 5) {
                doc.text(`... and ${miscExpenses.length - 5} more items`, 20, yPos);
                yPos += 7;
            }

            doc.text(`Total Misc Expenses: Rs ${cachedTotals.miscTotal.toFixed(2)}`, 20, yPos);
            yPos += 10;

            // Grand Total
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Grand Total', 20, yPos);
            doc.setFontSize(16);
            doc.text(`Rs ${grandTotal.toFixed(2)}`, 20, yPos + 10);

            // Detailed Misc Expenses (new page)
            if (miscExpenses.length > 0) {
                doc.addPage();
                yPos = 20;

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Detailed Miscellaneous Expenses', 105, yPos, { align: 'center' });

                yPos += 15;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');

                doc.setFillColor(240, 240, 240);
                doc.rect(20, yPos, 170, 8, 'F');
                doc.setFont(undefined, 'bold');
                doc.text('Date', 22, yPos + 6);
                doc.text('Description', 50, yPos + 6);
                doc.text('Amount (â‚¹)', 150, yPos + 6, { align: 'right' });

                yPos += 12;
                doc.setFont(undefined, 'normal');

                miscExpenses.forEach(expense => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }

                    doc.text(expense.date, 22, yPos + 6);
                    doc.text(expense.description, 50, yPos + 6);
                    doc.text(expense.amount.toFixed(2), 150, yPos + 6, { align: 'right' });
                    yPos += 10;
                });
            }

            // Daily Entries (new page)
            doc.addPage();
            yPos = 20;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Daily Entries', 105, yPos, { align: 'center' });

            yPos += 10;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');

            dailyEntries.forEach(entry => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                const line = `${entry.date}: Milk ${entry.milk}kg (Rs ${entry.milkCost.toFixed(2)})`;
                const papers = [];
                if (entry.theHindu) papers.push('Hindu');
                if (entry.hindustan) papers.push('Hindustan');
                const paperText = papers.length > 0 ? `, Papers: ${papers.join(', ')}` : '';

                doc.text(line + paperText, 20, yPos);
                yPos += 7;
            });

            doc.save(`expense-summary-${currentMonth}.pdf`);
            showStatus('PDF downloaded successfully!');
        }
    </script>
</body>
</html>